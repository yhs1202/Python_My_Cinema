<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>사진으로 얼굴 찾기</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* 전체 배경과 글꼴 */
        body{
                margin: 0;
                font-family: 'Arial', sans-serif;
                background-color: #0d0d0d; color: #f5f5f5; display: flex;
                flex-direction: column; align-items: center; min-height: 100vh;
                padding: 40px 0; box-sizing: border-box;
                background-image: url('https://images.unsplash.com/photo-1524985069026-dd778a71c7b4?auto=format&fit=crop&w=1470&q=80');
                background-size: cover; background-position: center; background-attachment: fixed; 
            }
        h1 {
                font-size: 3em;
                margin-bottom: 20px;
                color: #ffd700; text-shadow: 2px 2px 5px black;
                text-align: center;
            }
        .subtitle{ 
                text-align: center;
                font-size: 1.2em; color: #e0e0e0; margin-top: -15px;
                margin-bottom: 30px;
                margin-left: auto;
                margin-right: auto;
            }

        /* 업로드 박스(세로 3구역: 파일선택 / 버튼 / 미리보기) */
        .upload-wrap{
            background:rgba(0,0,0,.65);
            box-shadow:0 0 20px rgba(255,215,0,.7);
            border-radius:15px;
            padding:24px;
            margin-bottom:30px;
        }

        /* 상단 컨트롤바: 파일선택 + 인식버튼 */
        .controls-bar{
            position: absolute;            /* ★ 항상 박스 상단에 고정 */
            top: 12px;
            left: 12px;
            right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;       /* 가운데 정렬 */
            gap: 12px;
            z-index: 2;
        }

        /* 업로드 박스 */
        .upload-box{
            position: relative;     /* ★ 컨트롤바를 상단에 고정할 거라 필요 */
            width:720px;                 /* 박스 크게 */
            height:460px;                /* 박스 크게 */
            border:2px dashed #ffd700;
            border-radius:12px;
            display:flex;
            flex-direction:column;       /* 위→아래 배치 */
            justify-content:space-between;
            align-items:center;
            padding:16px;
            padding-top: 96px;             /* ★ 컨트롤바 아래로 미리보기 시작 */
            overflow: hidden;              /* 미리보기 이미지가 넘치지 않게 */
            background:rgba(0,0,0,.35);
            gap:8px;
        }
        /* ① 파일선택(상단) */
        .file-row{
            width:100%;
            display:flex;
            justify-content:center;
        }
        /* ② 버튼(정중앙) */
        .action-row{
            display:flex;
            justify-content:center;
        }
        /* 미리보기 영역: 컨트롤바 아래부터 바닥까지 */
        .preview-area{
            position: absolute;            /* ★ 남은 공간을 전부 차지 */
            top: 96px;                     /* padding-top과 같은 값 */
            left: 12px;
            right: 12px;
            bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            overflow: hidden;
        }
        /* 미리보기 이미지 */
        #preview{
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            display: none;                 /* 파일 선택 전 숨김 */
        }

        /* 공통 버튼/폼 */
        button{
            padding:12px 25px; font-size:1.2em; border:none; border-radius:8px;
            background:linear-gradient(45deg,#ffcc00,#ff9900);
            color:#000; font-weight:bold; cursor:pointer;
            box-shadow:0 0 15px rgba(255,204,0,.8);
            transition:transform .2s, box-shadow .2s;
        }
        button:hover{ transform:scale(1.05); box-shadow:0 0 25px rgba(255,204,0,1); }
        input[type="file"]{
            margin-bottom:0; padding:10px; border-radius:5px; border:none;
            background-color:#333; color:#fff; cursor:pointer;
        }

        #result-container{
            padding:20px; background-color:rgba(26,26,26,.85);
            border-radius:15px; box-shadow:0 0 15px rgba(255,215,0,.5);
            max-width:1200px; width:90%; display:none; margin-bottom:50px;
        }
        #result-container h2{ text-align:center; color:#ffd700; margin-bottom:20px; }

        .celebrity-card{ background-color:rgba(0,0,0,.5); padding:20px; border-radius:10px;
        margin-bottom:15px; border-left:5px solid #ff9900; display:flex; flex-direction:column; gap:20px; }
        .celebrity-card .main-content{ display:flex; flex-direction:row; gap:25px; width:100%; }
        .celebrity-card img{ width:300px; height:auto; border-radius:5px; align-self:flex-start; }
        .celebrity-card .info-wrapper{ display:flex; flex:1; gap:20px; }
        .celebrity-card .info-section{ flex:1.5; }
        .celebrity-card .news-section{ flex:1; }

        .info-table{ width:100%; border-collapse:collapse; }
        .info-table td{ padding:12px 8px; border-bottom:1px solid #444; vertical-align:top; font-size:1.1em; }
        .info-table tr:last-child td{ border-bottom:none; }
        .info-table td:first-child{ width:100px; font-weight:bold; color:#d4af37; }
        .info-table ul{ list-style:none; padding:0; margin:0; }
        .info-table ul li a{ color:#f5f5f5; text-decoration:underline; overflow-wrap:break-word; }
        .biography-section{ margin-top:20px; padding-top:15px; border-top:1px solid #555; }
        .biography-section h4{ margin-top:0; margin-bottom:10px; color:#d4af37; font-size:1.2em; }
        .biography-section p{ font-size:.95em; line-height:1.6; color:#e0e0e0; margin:0; max-height:150px; overflow-y:auto; padding-right:10px; }

        .social-links a{ color:#ccc; font-size:1.8em; margin:0 10px; text-decoration:none; transition:color .3s ease, transform .3s ease; display:inline-block; }
        .social-links a:hover{ color:#ffd700; transform:scale(1.1); }

        .news-section{ background-color:rgba(255,255,255,.05); padding:15px; border-radius:8px; max-height:450px; overflow-y:auto; }
        .news-section h4{ color:#ffd700; margin:0 0 10px 0; border-bottom:1px solid #ffd700; padding-bottom:5px; }
        .news-section ul{ list-style:none; padding:0; margin:0; }
        .news-section li{ margin-bottom:8px; }
        .news-section li a{ display:block; color:#f5f5f5; text-decoration:none; transition:color .3s ease; }
        .news-section li a:hover{ color:#ffd700; }
        .news-section .news-title{ font-weight:bold; }
        .news-section .news-source{ font-size:.8em; color:#aaa; }

        /* 필모그래피 */
        .filmography{
        display:flex; gap:20px; margin-top:18px; width:100%; flex-wrap:wrap;
        }
        .filmography .col{
            flex:1; min-width:300px;
            background:rgba(0,0,0,.45);
            padding:14px; border-radius:10px;
            max-height:360px;
            overflow:hidden;              /* ← 핵심: 바깥은 숨기고 안쪽에서 스크롤 */
            position: relative;
        }
        .filmography .col.movies{ border:2px solid #ff5555; }
        .filmography .col.tv{     border:2px solid #55aaff; }
        .filmography h4{ text-align:center; margin:0 0 10px 0; padding-bottom:6px; }
        .filmography .col.movies h4{ color:#ff5555; border-bottom:1px solid #ff5555; }
        .filmography .col.tv h4{     color:#55aaff; border-bottom:1px solid #55aaff; }

        /* ───────── “항상 보이는” 상단 가로 스크롤바 + 본문 스크롤 ───────── */
        .film-scroll-top{
            overflow-x:auto;
            overflow-y:hidden;
            height:16px;                 /* 스크롤바만 보이도록 얇게 */
            margin-bottom:6px;
        }
        .film-scroll-top::-webkit-scrollbar{ height:12px; }

        .film-scroll-body{
            overflow:auto;               /* 세로/가로 스크롤 모두 가능 */
            max-height:300px;            /* 카드 높이에 맞춰 조절 */
        }

        /* ───────── 표 ───────── */
        .film-table{
            min-width:900px;             /* 칼럼 5개(제목/연도/평점/배역/출연종류) 기준 */
            table-layout:fixed;
            border-collapse:collapse;
            width:100%;
        }
        .film-table th, .film-table td{
            padding: 8px 6px;
            border-bottom: 1px solid #444;
            font-size: .95em;
            vertical-align: top;
            white-space: nowrap;        /* 기본은 줄바꿈 금지 → 가로 스크롤 유도 */
        }
        /* 제목 칼럼: 줄바꿈 허용 + 영역 제한 */
        .film-table td.title {
            white-space: normal;   /* 자동 줄바꿈 허용 */
            word-break: break-word; /* 단어가 길면 강제로 쪼개줌 */
            max-width: 180px;      /* 제목 영역 너비 제한 (원하는 값으로 조정 가능) */
        }
        .film-table th.title {
            width: 18%;                 /* 제목 칼럼 폭 — 더 줄이고 싶으면 22~24% 추천 */
            max-width: 120px;           /* 제목 칼럼의 최대 픽셀 폭 */
            white-space: normal;        /* 제목만 줄바꿈 허용 */
        }

        .film-table td.title {
            white-space: normal;   /* 자동 줄바꿈 허용 */
            word-break: break-word; /* 긴 단어 강제 줄바꿈 */
            max-width: 180px;       /* 원하는 최대 폭 */
        }
        .film-table th{ text-align:left; color:#d4af37; }
        .film-table tr:last-child td{ border-bottom:none; }
        .film-table .title a {
            display: -webkit-box;          /* 멀티라인 말줄임 (WebKit) */
            display: box;                  /* 일부 구형 브라우저용 */
            -webkit-box-orient: vertical;  
            overflow: hidden;
            text-overflow: ellipsis;
            word-break: break-word;        /* 긴 단어 강제 줄바꿈 */
            color: #fff !important;
            text-decoration: none;

            line-clamp: 2;                 /* 표준 속성 (아직 지원 거의 없음) */
            -webkit-line-clamp: 2;         /* WebKit 전용, 실제 동작 */
    }
        .film-table td.title a:hover{ color:#ffd700 !important; text-decoration: underline; }

        @media (max-width:1100px){
        .celebrity-card .main-content,.celebrity-card .info-wrapper{ flex-direction:column; }
        .celebrity-card img{ align-self:center; }
        }
        @media (max-width:768px){ h1{ font-size:2.5em; } }
    </style>
</head>
<body>
    <div class="upload-wrap">
    <h1>얼굴 찾기</h1>
        <p class="subtitle">사진을 통해 연예인을 찾아보세요. 당신과 닮은 연예인도 찾아드립니다.</p>

        <form id="uploadForm" action="/find_celeb_face" method="post" enctype="multipart/form-data">
            <div class="upload-box" id="dropZone">
            <!-- 상단 고정 컨트롤바 -->
            <div class="controls-bar">
                <input type="file" id="fileInput" name="file1" accept="image/*" required>
                <button type="submit">인식</button>
            </div>

            <!-- 컨트롤바 아래 전 영역 미리보기 -->
            <div class="preview-area">
                <img id="preview" alt="미리보기">
            </div>
            </div>
        </form>
    </div>

    <!-- ▼▼ 이 아래를 추가하세요 ▼▼ -->
    <div id="result-container">
        <h2>인식 결과</h2>
        <div id="celebrity-info"></div>
    </div>
    <!-- ▲▲ 여기까지 추가 ▲▲ -->

    <script>
        // ADDED: 파일 선택 시 미리보기
        const fileInput   = document.getElementById('fileInput');
        const previewImg  = document.getElementById('preview');
        const dropZone    = document.getElementById('dropZone');

        function showPreview(file){
            if (!file) return;
            const url = URL.createObjectURL(file);
            previewImg.src = url;
            previewImg.style.display = 'block';
        }

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files?.[0];
            showPreview(file);
        });

        function buildFilmographyTable(rows, kind) {
        if (!rows || rows.length === 0) {
            return `<p style="color:#ccc;margin:4px 0 0 0;">데이터 없음</p>`;
        }

        let html = `
        <div class="film-scroll">
            <!-- 항상 보이는 가로 스크롤바(더미 폭을 표 폭으로 맞춤) -->
            <div class="film-scroll-top"><div class="film-scroll-dummy"></div></div>

            <!-- 실제 스크롤 영역(세로/가로) -->
            <div class="film-scroll-body">
            <table class="film-table">
                <thead>
                <tr>
                    <th class="title" style="width:10%">제목</th>   <!-- ← class="title" 추가 & 폭 축소 -->
                    <th style="width:5%">연도</th>
                    <th style="width:5%">평점</th>
                    <th style="width:10%">배역</th>
                    <th style="width:5%">출연종류</th>
                </tr>
                </thead>
                <tbody>
        `;

        rows.forEach(r=>{
            const vote = (r.vote != null ? Number(r.vote).toFixed(1) : 'N/A');
            const tmdbPath = (kind === 'tv') ? 'tv' : 'movie';
            const link = r.tmdb_id ? `https://www.themoviedb.org/${tmdbPath}/${r.tmdb_id}` : '#';

            html += `
            <tr>
                <td class="title"><a href="${link}" target="_blank" rel="noopener">${r.title || '-'}</a></td>
                <td>${r.year || '-'}</td>
                <td>${vote}</td>
                <td>${r.character || '-'}</td>
                <td>${r.role_type || '-'}</td>
            </tr>
            `;
        });

        html += `</tbody></table></div></div>`;
        return html;
        }

        const uploadForm = document.getElementById('uploadForm');
        const resultContainer = document.getElementById('result-container');
        const celebrityInfo = document.getElementById('celebrity-info');

        uploadForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const formData = new FormData(this);
            celebrityInfo.innerHTML = '<p style="text-align:center;">인식 중입니다. 잠시만 기다려주세요...</p>';
            resultContainer.style.display = 'block';

            fetch('/find_celeb_face', { method: 'POST', body: formData })
            .then(response => response.ok ? response.json() : Promise.reject(new Error('네트워크 응답 오류')))
            .then(data => {
                if (data.result === 'success' && data.celebrities && data.celebrities.length > 0) {
                    celebrityInfo.innerHTML = '';
                    data.celebrities.forEach(celeb => {
                        const card = document.createElement('div');
                        card.className = 'celebrity-card';

                        let imageHtml = `<img src="${celeb.image_url || 'https://via.placeholder.com/300x450?text=No+Image'}" alt="${celeb.name} 이미지">`;

                        function getLinkNameFromUrl(url) {
                            if (url.includes('imdb.com')) return 'IMDB';
                            if (url.includes('wikipedia.org')) return 'Wikipedia';
                            if (url.includes('wikidata.org')) return 'Wikidata';
                            try { return new URL(url).hostname.replace('www.', ''); } catch (e) { return url; }
                        }
                        function translateDepartment(department) {
                            if (department === 'Acting') return '배우';
                            if (department === 'Directing') return '감독';
                            return department || '정보 없음';
                        }

                        let infoTableHtml = `<table class="info-table">`;
                        infoTableHtml += `<tr><td>이름</td><td>${celeb.name || '-'}</td></tr>`;
                        infoTableHtml += `<tr><td>성별</td><td>${celeb.gender || '-'}</td></tr>`;
                        infoTableHtml += `<tr><td>직업</td><td>${translateDepartment(celeb.known_for_department)}</td></tr>`;
                        infoTableHtml += `<tr><td>생년월일</td><td>${celeb.birthday || '정보 없음'}</td></tr>`;
                        infoTableHtml += `<tr><td>출생지</td><td>${celeb.place_of_birth || '정보 없음'}</td></tr>`;

                        if (celeb.urls && celeb.urls.length > 0) {
                            let urlsList = '';
                            celeb.urls.forEach(url => {
                                const fullUrl = url.startsWith('http') ? url : `http://${url}`;
                                urlsList += `<li><a href="${fullUrl}" target="_blank">${getLinkNameFromUrl(fullUrl)}</a></li>`;
                            });
                            if (urlsList) infoTableHtml += `<tr><td>관련 정보</td><td><ul>${urlsList}</ul></td></tr>`;
                        }

                        let socialLinksHtml = '';
                        const ids = celeb.external_ids || {};
                        if (ids.instagram_id) socialLinksHtml += `<a href="https://www.instagram.com/${ids.instagram_id}" target="_blank"><i class="fa-brands fa-instagram"></i></a>`;
                        if (ids.twitter_id)   socialLinksHtml += `<a href="https://twitter.com/${ids.twitter_id}" target="_blank"><i class="fa-brands fa-x-twitter"></i></a>`;
                        if (ids.facebook_id)  socialLinksHtml += `<a href="https://www.facebook.com/${ids.facebook_id}" target="_blank"><i class="fa-brands fa-facebook"></i></a>`;
                        if (socialLinksHtml) infoTableHtml += `<tr><td>소셜</td><td><div class="social-links">${socialLinksHtml}</div></td></tr>`;

                        infoTableHtml += `</table>`;

                        let biographyHtml = '';
                        if (celeb.biography && celeb.biography.trim() !== '') {
                            biographyHtml = `<div class="biography-section"><h4>소개</h4><p>${celeb.biography.replace(/\n/g, '<br>')}</p></div>`;
                        }
                        
                        let infoSectionHtml = `<div class="info-section">${infoTableHtml}${biographyHtml}</div>`;
                        
                        let newsHtml = `<div class="news-section"><h4>최신 뉴스</h4>`;
                        if (celeb.news && celeb.news.length > 0) {
                            newsHtml += '<ul>';
                            celeb.news.forEach(newsArticle => {
                                newsHtml += `<li><a href="${newsArticle.url}" target="_blank">
                                    <span class="news-title">${newsArticle.title}</span><br>
                                    <span class="news-source">출처: ${newsArticle.source}</span>
                                </a></li>`;
                            });
                            newsHtml += '</ul>';
                        } else {
                            newsHtml += `<p>최신 뉴스 정보를 찾을 수 없습니다.</p>`;
                        }
                        newsHtml += `</div>`;

                        const films = celeb.filmography || { movies: [], tv: [] };
                        const movieTableHtml = buildFilmographyTable(films.movies, 'movie');
                        const tvTableHtml    = buildFilmographyTable(films.tv, 'tv');
                        const filmographyHtml = `
                            <div class="filmography">
                                <div class="col movies">
                                    <h4>영화</h4>
                                    ${movieTableHtml}
                                </div>
                                <div class="col tv">
                                    <h4>TV/예능</h4>
                                    ${tvTableHtml}
                                </div>
                            </div>
                        `;

                        card.innerHTML = `
                            <div class="main-content">
                                ${imageHtml}
                                <div class="info-wrapper">
                                    ${infoSectionHtml}
                                    ${newsHtml}
                                </div>
                            </div>
                            ${filmographyHtml}
                        `;
                        
                        celebrityInfo.appendChild(card);
                    });
                } else {
                    celebrityInfo.innerHTML = `<p style="text-align:center;">${data.message || '사진에서 유명인을 찾을 수 없습니다.'}</p>`;
                }
            })
            .catch(error => {
                celebrityInfo.innerHTML = `<p style="text-align:center;">오류가 발생했습니다: ${error.message}</p>`;
            });
        });
    </script>
</body>
</html>
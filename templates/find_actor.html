<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>사진으로 얼굴 찾기</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* 전체 배경과 글꼴 */
        body { margin: 0; font-family: 'Arial', sans-serif; background-color: #0d0d0d; color: #f5f5f5; display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 40px 0; box-sizing: border-box; background-image: url('https://images.unsplash.com/photo-1524985069026-dd778a71c7b4?auto=format&fit=crop&w=1470&q=80'); background-size: cover; background-position: center; background-attachment: fixed; }
        h1 { font-size: 3em; margin-bottom: 20px; color: #ffd700; text-shadow: 2px 2px 5px black; }
        .subtitle { font-size: 1.2em; color: #e0e0e0; margin-top: -15px; margin-bottom: 30px; text-align: center; }

        /* 입력 방식 선택 UI */
        .input-container { display: flex; flex-direction: column; align-items: center; background-color: rgba(0,0,0,0.7); padding: 30px 50px; border-radius: 15px; box-shadow: 0 0 20px rgba(255, 215, 0, 0.7); margin-bottom: 30px; }
        .tab-buttons { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-button { padding: 10px 20px; font-size: 1em; border: 1px solid #ffd700; border-radius: 8px; background-color: transparent; color: #ffd700; cursor: pointer; transition: background-color 0.3s, color 0.3s; }
        .tab-button.active { background-color: #ffd700; color: #000; }
        .input-area { display: none; flex-direction: column; align-items: center; }
        .input-area.active { display: flex; }

        input[type="file"] { margin-bottom: 20px; padding: 10px; border-radius: 5px; border: none; background-color: #333; color: #fff; cursor: pointer; }
        button { padding: 12px 25px; font-size: 1.2em; border: none; border-radius: 8px; background: linear-gradient(45deg, #ffcc00, #ff9900); color: #000; font-weight: bold; cursor: pointer; box-shadow: 0 0 15px rgba(255, 204, 0, 0.8); transition: transform 0.2s, box-shadow 0.2s; }
        button:hover { transform: scale(1.05); box-shadow: 0 0 25px rgba(255, 204, 0, 1); }
        
        /* 카메라 관련 UI */
        #camera-view { border-radius: 10px; margin-bottom: 20px; max-width: 100%; width: 500px; background-color: #000; }
        #camera-controls button { margin: 0 5px; }

        /* 결과 표시 영역 */
        #result-container { padding: 20px; background-color: rgba(26, 26, 26, 0.85); border-radius: 15px; box-shadow: 0 0 15px rgba(255, 215, 0, 0.5); max-width: 1200px; width: 90%; display: none; margin-bottom: 50px; }
        #result-container h2 { text-align: center; color: #ffd700; margin-bottom: 20px; }
        .celebrity-card { background-color: rgba(0, 0, 0, 0.5); padding: 20px; border-radius: 10px; margin-bottom: 15px; border-left: 5px solid #ff9900; display: flex; flex-direction: column; gap: 20px; }
        .celebrity-card .main-content { display: flex; flex-direction: row; gap: 25px; width: 100%; }
        .celebrity-card img { width: 300px; height: auto; border-radius: 5px; align-self: flex-start; }
        .celebrity-card .info-wrapper { display: flex; flex: 1; gap: 20px; }
        .celebrity-card .info-section { flex: 1.5; }
        .celebrity-card .news-section { flex: 1; }

        /* 정보 테이블 */
        .info-table { width: 100%; border-collapse: collapse; }
        .info-table td { padding: 12px 8px; border-bottom: 1px solid #444; vertical-align: top; font-size: 1.1em; }
        .info-table tr:last-child td { border-bottom: none; }
        .info-table td:first-child { width: 100px; font-weight: bold; color: #d4af37; }
        .info-table ul { list-style: none; padding: 0; margin: 0; }
        .info-table ul li a { color: #f5f5f5; text-decoration: underline; overflow-wrap: break-word; }
        
        /* 소개 섹션 */
        .biography-section { margin-top: 20px; padding-top: 15px; border-top: 1px solid #555; }
        .biography-section h4 { margin-top: 0; margin-bottom: 10px; color: #d4af37; font-size: 1.2em; }
        .biography-section p { font-size: 0.95em; line-height: 1.6; color: #e0e0e0; margin: 0; max-height: 150px; overflow-y: auto; padding-right: 10px; }
        
        /* 소셜 링크 */
        .social-links a { color: #ccc; font-size: 1.8em; margin: 0 10px; text-decoration: none; transition: color 0.3s ease, transform 0.3s ease; display: inline-block; }
        .social-links a:hover { color: #ffd700; transform: scale(1.1); }

        /* 뉴스 섹션 */
        .news-section { background-color: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 8px; max-height: 450px; overflow-y: auto;}
        .news-section h4 { color: #ffd700; margin: 0 0 10px 0; border-bottom: 1px solid #ffd700; padding-bottom: 5px; }
        .news-section ul { list-style: none; padding: 0; margin: 0;}
        .news-section li { margin-bottom: 8px; }
        .news-section li a { display: block; color: #f5f5f5; text-decoration: none; transition: color 0.3s ease; }
        .news-section li a:hover { color: #ffd700; }
        .news-section .news-title { font-weight: bold; }
        .news-section .news-source { font-size: 0.8em; color: #aaa; }
        
        /* 필모그래피 */
        .filmography { display:flex; gap:20px; margin-top:18px; width:100%; flex-wrap: wrap; }
        .filmography .col { flex:1; min-width: 300px; background:rgba(0,0,0,.45); padding:14px; border-radius:10px; max-height:360px; overflow:auto; }
        .filmography .col.movies { border:2px solid #ff5555; }
        .filmography .col.tv { border:2px solid #55aaff; } 
        .filmography h4 { text-align: center; margin:0 0 10px 0; padding-bottom:6px; }
        .filmography .col.movies h4 { color:#ff5555; border-bottom:1px solid #ff5555; }
        .filmography .col.tv h4 { color:#55aaff; border-bottom:1px solid #55aaff; }
        .film-table { width:100%; border-collapse:collapse; }
        .film-table th, .film-table td { padding:8px 6px; border-bottom:1px solid #444; font-size:.95em; vertical-align:top; }
        .film-table th { text-align:left; color:#d4af37; }
        .film-table tr:last-child td { border-bottom:none; }
        .film-table .title a { color: #fff !important; text-decoration: none; }
        .film-table .title a:hover { color: #ffd700 !important; text-decoration: underline; }

        /* 반응형 디자인 */
        @media (max-width: 1100px) { .celebrity-card .main-content, .celebrity-card .info-wrapper { flex-direction: column; } .celebrity-card img { align-self: center; } }
        @media (max-width: 768px) { h1 { font-size: 2.5em; } }
    </style>
</head>
<body>
    <h1>얼굴 찾기</h1>
    <p class="subtitle">사진을 통해 연예인을 찾아보세요.</p>
    
    <div class="input-container">
        <div class="tab-buttons">
            <button class="tab-button active" data-tab="file-upload">파일 업로드</button>
            <button class="tab-button" data-tab="camera">카메라로 찍기</button>
        </div>

        <div id="file-upload-area" class="input-area active">
            <form id="uploadForm">
                <input type="file" name="file1" accept="image/*" required>
                <button type="submit">인식</button>
            </form>
        </div>

        <div id="camera-area" class="input-area">
            <video id="camera-view" autoplay playsinline></video>
            <div id="camera-controls">
                <button id="take-photo-btn">사진 찍기</button>
            </div>
        </div>
    </div>

    <div id="result-container">
        <h2>인식 결과</h2>
        <div id="celebrity-info"></div>
    </div>
    
    <canvas id="photo-canvas" style="display:none;"></canvas>

    <script>
        function buildFilmographyTable(rows, kind) {
            if (!rows || rows.length === 0) {
                return `<p style="color:#ccc;margin:4px 0 0 0;">데이터 없음</p>`;
            }
            let html = `
                <table class="film-table">
                    <thead>
                        <tr>
                            <th style="width:40%">제목</th>
                            <th style="width:15%">연도</th>
                            <th style="width:15%">평점</th>
                            <th style="width:30%">배역</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            rows.forEach(function(r){
                var vote = (r.vote != null ? r.vote.toFixed(1) : 'N/A');
                var tmdbPath = (kind === 'tv') ? 'tv' : 'movie';
                var link = r.tmdb_id ? `https://www.themoviedb.org/${tmdbPath}/${r.tmdb_id}` : '#';
                html += `
                        <tr>
                            <td class="title"><a href="${link}" target="_blank" rel="noopener">${r.title || '-'}</a></td>
                            <td>${r.year || '-'}</td>
                            <td>${vote}</td>
                            <td>${r.character || '-'}</td>
                        </tr>
                `;
            });
            html += `</tbody></table>`;
            return html;
        }

        const uploadForm = document.getElementById('uploadForm');
        const resultContainer = document.getElementById('result-container');
        const celebrityInfo = document.getElementById('celebrity-info');
        const tabButtons = document.querySelectorAll('.tab-button');
        const inputAreas = document.querySelectorAll('.input-area');
        const video = document.getElementById('camera-view');
        const canvas = document.getElementById('photo-canvas');
        const takePhotoBtn = document.getElementById('take-photo-btn');
        let stream;

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.dataset.tab;
                tabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                inputAreas.forEach(area => {
                    area.id === `${tabId}-area` ? area.classList.add('active') : area.classList.remove('active');
                });
                tabId === 'camera' ? startCamera() : stopCamera();
            });
        });

        async function startCamera() {
            if (stream) return;
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
            } catch (err) {
                console.error("카메라 접근 오류:", err);
                alert(err.message || "카메라를 사용할 수 없습니다. 브라우저 설정을 확인해주세요.");
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
                video.srcObject = null;
            }
        }

        takePhotoBtn.addEventListener('click', () => {
            if (!stream) return alert("카메라가 활성화되지 않았습니다.");
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            canvas.toBlob(blob => {
                const formData = new FormData();
                formData.append('file1', blob, 'capture.jpg');
                sendToServer(formData);
                stopCamera();
                document.querySelector('.tab-button[data-tab="file-upload"]').click();
            }, 'image/jpeg');
        });

        uploadForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const formData = new FormData(this);
            sendToServer(formData);
        });

        function sendToServer(formData) {
            celebrityInfo.innerHTML = '<p style="text-align:center;">인식 중입니다. 잠시만 기다려주세요...</p>';
            resultContainer.style.display = 'block';

            fetch('/find_celeb_face', { method: 'POST', body: formData })
            .then(response => response.ok ? response.json() : Promise.reject(new Error('네트워크 응답 오류')))
            .then(data => {
                if (data.result === 'success' && data.celebrities && data.celebrities.length > 0) {
                    celebrityInfo.innerHTML = '';
                    data.celebrities.forEach(celeb => {
                        const card = document.createElement('div');
                        card.className = 'celebrity-card';

                        let imageHtml = `<img src="${celeb.image_url || 'https://via.placeholder.com/300x450?text=No+Image'}" alt="${celeb.name} 이미지">`;

                        function getLinkNameFromUrl(url) {
                            if (url.includes('imdb.com')) return 'IMDB';
                            if (url.includes('wikipedia.org')) return 'Wikipedia';
                            if (url.includes('wikidata.org')) return 'Wikidata';
                            try { return new URL(url).hostname.replace('www.', ''); } catch (e) { return url; }
                        }
                        function translateDepartment(department) {
                            if (department === 'Acting') return '배우';
                            if (department === 'Directing') return '감독';
                            return department || '정보 없음';
                        }

                        let infoTableHtml = `<table class="info-table">`;
                        infoTableHtml += `<tr><td>이름</td><td>${celeb.name || '-'}</td></tr>`;
                        infoTableHtml += `<tr><td>성별</td><td>${celeb.gender || '-'}</td></tr>`;
                        infoTableHtml += `<tr><td>직업</td><td>${translateDepartment(celeb.known_for_department)}</td></tr>`;
                        infoTableHtml += `<tr><td>생년월일</td><td>${celeb.birthday || '정보 없음'}</td></tr>`;
                        infoTableHtml += `<tr><td>출생지</td><td>${celeb.place_of_birth || '정보 없음'}</td></tr>`;

                        if (celeb.urls && celeb.urls.length > 0) {
                            let urlsList = '';
                            celeb.urls.forEach(url => {
                                const fullUrl = url.startsWith('http') ? url : `http://${url}`;
                                urlsList += `<li><a href="${fullUrl}" target="_blank">${getLinkNameFromUrl(fullUrl)}</a></li>`;
                            });
                            if (urlsList) infoTableHtml += `<tr><td>관련 정보</td><td><ul>${urlsList}</ul></td></tr>`;
                        }

                        let socialLinksHtml = '';
                        const ids = celeb.external_ids || {};
                        if (ids.instagram_id) socialLinksHtml += `<a href="https://www.instagram.com/${ids.instagram_id}" target="_blank"><i class="fa-brands fa-instagram"></i></a>`;
                        if (ids.twitter_id)   socialLinksHtml += `<a href="https://twitter.com/${ids.twitter_id}" target="_blank"><i class="fa-brands fa-x-twitter"></i></a>`;
                        if (ids.facebook_id)  socialLinksHtml += `<a href="https://www.facebook.com/${ids.facebook_id}" target="_blank"><i class="fa-brands fa-facebook"></i></a>`;
                        if (socialLinksHtml) infoTableHtml += `<tr><td>소셜</td><td><div class="social-links">${socialLinksHtml}</div></td></tr>`;

                        infoTableHtml += `</table>`;

                        let biographyHtml = '';
                        if (celeb.biography && celeb.biography.trim() !== '') {
                            biographyHtml = `<div class="biography-section"><h4>소개</h4><p>${celeb.biography.replace(/\n/g, '<br>')}</p></div>`;
                        }
                        
                        let infoSectionHtml = `<div class="info-section">${infoTableHtml}${biographyHtml}</div>`;
                        
                        let newsHtml = `<div class="news-section"><h4>최신 뉴스</h4>`;
                        if (celeb.news && celeb.news.length > 0) {
                            newsHtml += '<ul>';
                            celeb.news.forEach(newsArticle => {
                                newsHtml += `<li><a href="${newsArticle.url}" target="_blank">
                                    <span class="news-title">${newsArticle.title}</span><br>
                                    <span class="news-source">출처: ${newsArticle.source}</span>
                                </a></li>`;
                            });
                            newsHtml += '</ul>';
                        } else {
                            newsHtml += `<p>최신 뉴스 정보를 찾을 수 없습니다.</p>`;
                        }
                        newsHtml += `</div>`;

                        const films = celeb.filmography || { movies: [], tv: [] };
                        const movieTableHtml = buildFilmographyTable(films.movies, 'movie');
                        const tvTableHtml    = buildFilmographyTable(films.tv, 'tv');
                        const filmographyHtml = `
                            <div class="filmography">
                                <div class="col movies">
                                    <h4>영화</h4>
                                    ${movieTableHtml}
                                </div>
                                <div class="col tv">
                                    <h4>TV/예능</h4>
                                    ${tvTableHtml}
                                </div>
                            </div>
                        `;

                        card.innerHTML = `
                            <div class="main-content">
                                ${imageHtml}
                                <div class="info-wrapper">
                                    ${infoSectionHtml}
                                    ${newsHtml}
                                </div>
                            </div>
                            ${filmographyHtml}
                        `;
                        
                        celebrityInfo.appendChild(card);
                    });
                } else {
                    celebrityInfo.innerHTML = `<p style="text-align:center;">${data.message || '사진에서 유명인을 찾을 수 없습니다.'}</p>`;
                }
            })
            .catch(error => {
                celebrityInfo.innerHTML = `<p style="text-align:center;">오류가 발생했습니다: ${error.message}</p>`;
            });
        }
    </script>
</body>
</html>
